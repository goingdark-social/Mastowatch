version: "3.8"

# Shared environment variables
x-backend-env: &backend-env
  INSTANCE_BASE: "${INSTANCE_BASE}"
  ADMIN_TOKEN: "${ADMIN_TOKEN}"
  BOT_TOKEN: "${BOT_TOKEN}"
  DATABASE_URL: "${DATABASE_URL}"
  REDIS_URL: "${REDIS_URL}"
  API_KEY: "${API_KEY}"
  WEBHOOK_SECRET: "${WEBHOOK_SECRET}"
  DRY_RUN: "${DRY_RUN:-true}"
  PANIC_STOP: "${PANIC_STOP:-false}"
  CORS_ORIGINS: "${CORS_ORIGINS:-http://localhost:3000}"

services:
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      <<: *backend-env
    depends_on:
      - db
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:80"
    depends_on:
      - api

  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: ["celery", "-A", "app.tasks.celery", "worker", "--loglevel=info"]
    environment:
      <<: *backend-env
    depends_on:
      - db
      - redis

  beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: ["celery", "-A", "app.tasks.celery", "beat", "--loglevel=info"]
    environment:
      <<: *backend-env
    depends_on:
      - db
      - redis

  migrate:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: ["alembic", "upgrade", "head"]
    environment:
      <<: *backend-env
    depends_on:
      - db

  db:
    image: postgres:17
    environment:
      POSTGRES_DB: mastowatch
      POSTGRES_USER: mastowatch
      POSTGRES_PASSWORD: mastowatch
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mastowatch -d mastowatch"]
      interval: 5s
      timeout: 5s
      retries: 10

  redis:
    image: redis:8
    command: ["redis-server", "--appendonly", "yes"]
